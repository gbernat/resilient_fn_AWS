<!--
  This User README.md is generated by running:
  "resilient-sdk docgen -p fn_aws --user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_aws_v1.0.0

## Table of Contents
- [Key Features](#key-features)
- [Function - AWS: create tags](#function---aws-create-tags)
- [Function - AWS: EC2 describe Instance](#function---aws-ec2-describe-instance)
- [Function - AWS: EC2 create snapshot](#function---aws-ec2-create-snapshot)
- [Function - AWS: delete key pair](#function---aws-delete-key-pair)
- [Function - AWS: EC2 describe Security Group](#function---aws-ec2-describe-security-group)
- [Function - AWS: Lambda invoke function](#function---aws-lambda-invoke-function)
- [Function - AWS: EC2 modify security groups](#function---aws-ec2-modify-security-groups)
- [Function - AWS: EC2 change instance status](#function---aws-ec2-change-instance-status)
- [Data Table - AWS Instances](#data-table---aws-instances)
- [Data Table - AWS Security Groups](#data-table---aws-security-groups)
- [Custom Artifact Types](#custom-artifact-types)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Retrieve comprehensive information about AWS EC2 instances and security groups affected by a security incident.
* Multiple search criteria, and many objects can be queried at once.
* Create tags for AWS resources.
* Ability to create AMI copies of an Instance, and Volume snapshots.
* Replace the assigned security groups of an instance.
* Start, Stop, Hibernate o Terminate one or more instances.
* Delete compromised key pairs.
* Execute Lambda functions synchronously, whether with input event or not.


---

## Function - AWS: create tags
Assign Tags to resources. Multiple Tags and resources are allowed. 
Input multiple resources as: ami-xxx...xxx,i-xxx...xxx.
If a tag key already exists, the value is overwritten with the new value.

 ![screenshot: fn-aws-create-tags ](./screenshots/wfTag.png)
 
#### IAM permissions required:
* ec2:CreateTags

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |
| `aws_tag_names` | `text` | Yes | `"[{'Key': 'First_Tag', 'Value': 'First Value'}, {'Key': 'Second_Tag', 'Value': 'Second Value'}]"` | - |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {'success': True} 
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_region = 'sa-east-1'

inputs.aws_tag_names = "[{ 'Key': 'source', 'Value': 'Resilient' }, { 'Key': 'security_posture', 'Value': 'quarantine' }]"
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  incident.addNote('Tags created')
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 describe Instance
Gets the information of one o more Instance listed in aws_resource_id.
Searching by Instance Id is default. If 'image-id' is selected in aws_instances_filter_name, and one or more AMI id is entered, the output includes Instance information related to that AMI Id.

 ![screenshot: fn-aws-ec2-describe-instance ](./screenshots/wfDesribeInstance.png)

#### IAM permissions required:
* ec2:DescribeInstances

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_instances_filter_name` | `select` | No | `-` | Criteria for searching instances |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True,
    "reservations": [
        {
            "Groups": [],
            "Instances": [
                {
                    "AmiLaunchIndex": 0,
                    "ImageId": "",
                    "InstanceId": "",
                    "InstanceType": "",
                    "KeyName": "",
                    "LaunchTime": "",
                    "Monitoring": {
                        "State": ""
                    },
                    "Placement": {
                        "AvailabilityZone": "",
                        "GroupName": "",
                        "Tenancy": ""
                    },
                    "PrivateDnsName": "",
                    "PrivateIpAddress": "",
                    "ProductCodes": [],
                    "PublicDnsName": "",
                    "State": {
                        "Code": 80,
                        "Name": ""
                    },
                    "StateTransitionReason": "",
                    "SubnetId": "",
                    "VpcId": "",
                    "Architecture": "",
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "",
                            "Ebs": {
                                "AttachTime": "",
                                "DeleteOnTermination": ,
                                "Status": "",
                                "VolumeId": ""
                            }
                        }
                    ],
                    "ClientToken": "",
                    "EbsOptimized": ,
                    "EnaSupport": ,
                    "Hypervisor": "",
                    "NetworkInterfaces": [
                        {
                            "Attachment": {
                                "AttachTime": "",
                                "AttachmentId": "",
                                "DeleteOnTermination": ,
                                "DeviceIndex": 0,
                                "Status": ""
                            },
                            "Description": "",
                            "Groups": [
                                {
                                    "GroupName": "",
                                    "GroupId": ""
                                }
                            ],
                            "Ipv6Addresses": [],
                            "MacAddress": "",
                            "NetworkInterfaceId": "",
                            "OwnerId": "",
                            "PrivateDnsName": "",
                            "PrivateIpAddress": "",
                            "PrivateIpAddresses": [
                                {
                                    "Primary": ,
                                    "PrivateDnsName": "",
                                    "PrivateIpAddress": ""
                                }
                            ],
                            "SourceDestCheck": ,
                            "Status": "",
                            "SubnetId": "",
                            "VpcId": "",
                            "InterfaceType": ""
                        }
                    ],
                    "RootDeviceName": "",
                    "RootDeviceType": "",
                    "SecurityGroups": [
                        {
                            "GroupName": "",
                            "GroupId": ""
                        }
                    ],
                    "SourceDestCheck": ,
                    "StateReason": {
                        "Code": "",
                        "Message": ""
                    },
                    "Tags": [
                        {
                            "Key": "",
                            "Value": ""
                        }
                    ],
                    "VirtualizationType": "",
                    "CpuOptions": {
                        "CoreCount": 1,
                        "ThreadsPerCore": 1
                    },
                    "CapacityReservationSpecification": {
                        "CapacityReservationPreference": ""
                    },
                    "HibernationOptions": {
                        "Configured": 
                    },
                    "MetadataOptions": {
                        "State": "",
                        "HttpTokens": "",
                        "HttpPutResponseHopLimit": 1,
                        "HttpEndpoint": ""
                    },
                    "EnclaveOptions": {
                        "Enabled": 
                    }
                }
            ],
            "OwnerId": "",
            "ReservationId": ""
        }
    ]
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_region = 'sa-east-1'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # Processing if the function is a success
if(results.success):
  reservations = results.reservations
  
  for rsv in reservations:
    instances = rsv['Instances']
  
    for inst in instances:
      # Add Row
      row = incident.addRow("aws_instances")
      row["instanceid"] = inst["InstanceId"]
      row["imageid"] = inst["ImageId"]
      row["instancetype"] = inst["InstanceType"]
      row["keyname"] = inst["KeyName"]
      row["launchtime"] = inst["LaunchTime"]
      row["availabilityzone"] = inst["Placement"]["AvailabilityZone"]
      row["privatednsname"] = inst["PrivateDnsName"]
      row["publicdnsname"] = inst["PublicDnsName"]
      row["instance_state"] = inst["State"]["Name"]
      row["vpcid"] = inst["VpcId"]
      row["securitygroups"] = ('\n'.join(list(map(lambda x : x['GroupName']+' ('+x['GroupId']+')', inst["SecurityGroups"]))) if "SecurityGroups" in inst.keys() else '')
      row["tags"] = ('\n'.join(list(map(lambda x : x['Key']+': '+x['Value'], inst["Tags"]))) if "Tags" in inst.keys() else '')
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 create snapshot
Creates a volume snapshot if aws_resource_id is a Volume (vol-xxx..xxx), or creates a complete image if it is an Instance Id (i-xxx...xxx)

#### IAM permissions required:
* ec2:CreateSnapshot
* ec2:CreateImage

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `For Volume snapshot enter: vol-xx..xx. To create AMI from Instance enter: i-xx..xx` | Where multiple values are allowed, enter them separated  by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {'success': True, 'snapshotId': 'ami-xx..xx'}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('AMI from {} successfully created: {}'.format(artifact.value, results.snapshotId))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: delete key pair
Deletes the specified key pair, by removing the public key from Amazon EC2.
Use with extremely careful.<br>
The output shows the status prior to deletion.

#### IAM permissions required:
* ec2:DeleteKeyPair
* ec2:DescribeKeyPairs

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_key_name` | `text` | Yes | `frontend_dev` | key name |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True,
    "deletedKeyPair": {
        "KeyPairId": "key-xx..xx",
        "KeyFingerprint": "57:::::::::::::::::::52",
        "KeyName": "frontend_dev",
        "Tags": [
            {
                "Key": "origin",
                "Value": "resilient"
            }
        ]
    }
}
```

</p>
</details>

---
## Function - AWS: EC2 describe Security Group
Gets the information of one o more Security Group listed in aws_resource_id.
Searching by Security Group Id is default. Other options are available by changing aws_security_group_filter_name.

 ![screenshot: fn-aws-ec2-describe-security-group ](./screenshots/wfDescribeSecurityGroups.png)

#### IAM permissions required:
* ec2:DescribeSecurityGroups

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | For multiple resources searching, enter them separated  by commas |
| `aws_security_group_filter_name` | `select` | No | `vpc-id / group-id / group-name` | Criteria for searching security groups |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True,
    "securityGroups": [
        {
            "Description": "",
            "GroupName": "",
            "IpPermissions": [
                {
                    "FromPort": ,
                    "IpProtocol": "",
                    "IpRanges": [
                        {
                            "CidrIp": ""
                        }
                    ],
                    "Ipv6Ranges": [],
                    "PrefixListIds": [],
                    "ToPort": ,
                    "UserIdGroupPairs": []
                }
            ],
            "OwnerId": "",
            "GroupId": "",
            "IpPermissionsEgress": [
                {
                    "IpProtocol": "",
                    "IpRanges": [
                        {
                            "CidrIp": ""
                        }
                    ],
                    "Ipv6Ranges": [],
                    "PrefixListIds": [],
                    "UserIdGroupPairs": []
                }
            ],
            "VpcId": ""
        }
    ]
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  vpc = workflow.properties.instance_data.reservations[0]['Instances'][0]['VpcId']


inputs.aws_security_group_filter_name = 'vpc-id'
inputs.aws_resource_id = vpc



  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python

# Processing if the function is a success
if(results.success):
  sgs = results['securityGroups']
  
  for inst in sgs:
    # Add Row
    row = incident.addRow("aws_security_groups")
    
    row["groupname"] = inst["GroupName"]
    row["sgdescription"] = inst["Description"]
    row["sgownerid"] = inst["OwnerId"]
    row["sggroupid"] = inst["GroupId"]
    row["vpcid"] = inst["VpcId"]

  ```

  </p>
  </details>

</details>

---
## Function - AWS: Lambda invoke function
Invokes synchronously a Lambda function.<br>
If the function expects an input event, enter it as json in 'aws_lamdba_payload' input field.<br>
If your Lambda function has logs output, the content of 'LogResult' of the lambda API invoke is return in results, otherwise it is return the entire response of the API for you to decide wich information is relevant (see API documentation: [invoke](https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html#API_Invoke_ResponseSyntax))

 ![screenshot: fn-aws-lambda-invoke-function ](./screenshots/wfInvokeLambda.png)

#### IAM permissions required:
* lambda:InvokeFunction

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_lambda_function_name` | `text` | Yes | `-` | The lambda function name to invoke |
| `aws_lambda_payload` | `text` | No | `-` | The JSON that you want to provide to your Lambda function as input if needed |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True,
    "lambdaResult": "START RequestId: xx..xx Version: $LATEST\n
    Received event: {}\n
    ...
    lambda funcion output
    ...
    END RequestId: xx..xx\n
    REPORT RequestId: xx..xx\tDuration: 3051.58 ms\tBilled Duration: 3052 ms\t
    Memory Size: 1024 MB\tMax Memory Used: 100 MB\tInit Duration: 585.11 ms\t\n"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_lambda_function_name = 'my-lambda-function'
inputs.aws_lambda_payload = '{"key1":"value1","key2":"value2"}'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  incident.addNote(str(results.lambdaResult))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 modify security groups
Replaces the Security Groups assigned to the Instance for those described in aws_security_groups (can be a list of security group Ids separated by comma)

#### IAM permissions required:
* ec2:ModifyInstanceAttribute

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |
| `aws_security_groups` | `text` | Yes | `sg-03..bc,sg-01..bb` | List of security groups Ids separated by comma to set in the Instance |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_security_groups = 'sg-032..bc,sg-01..bb'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('Security Groups for Instance: {} were successfully changed.'.format(artifact.value))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 change instance status
A function to change the state of one or more instances.
If hibernate is selected but the instances cannot hibernate successfully, a normal shutdown occurs.
Terminate instances is also allowed (use with extremely careful).

 ![screenshot: fn-aws-ec2-change-instance-status ](./screenshots/wfSnapshotAndHibernate.png)

#### IAM permissions required:
* ec2:StopInstances
* ec2:TerminateInstances
* ec2:StartInstances

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_instance_status` | `select` | Yes | `hibernate / stop / start / terminate` | - |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True,
    "statusInstances": {
        "StoppingInstances": [
            {
                "CurrentState": {
                    "Code": 64,
                    "Name": "stopping"
                },
                "InstanceId": "",
                "PreviousState": {
                    "Code": 16,
                    "Name": "running"
                }
            }
        ],
        "ResponseMetadata": {
            "RequestId": "",
            "HTTPStatusCode": 200,
            "HTTPHeaders": {
                "x-amzn-requestid": "",
                "cache-control": "",
                "strict-transport-security": "",
                "content-type": "",
                "content-length": "",
                "date": "",
                "server": ""
            },
            "RetryAttempts": 0
        }
    }
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
  inputs.aws_instance_status = 'stop'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('Status change results: {}'.format(str(results.statusInstances)))
  
  ```

  </p>
  </details>

</details>

---

## Data Table - AWS Instances

 ![screenshot: dt-aws-instances](./screenshots/tableAWSInstancesCapture.png)

#### API Name:
aws_instances

#### Columns:
| Column Name | API Access Name | Type |
| ----------- | --------------- | ---- |
| AvailabilityZone | `availabilityzone` | `text` |
| ImageId | `imageid` | `text` |
| State | `instance_state` | `text` |
| InstanceId | `instanceid` | `text` |
| InstanceType | `instancetype` | `text` |
| KeyName | `keyname` | `text` |
| LaunchTime | `launchtime` | `text` |
| PrivateDnsName | `privatednsname` | `text` |
| PublicDnsName | `publicdnsname` | `text` |
| SecurityGroups | `securitygroups` | `textarea` |
| Tags | `tags` | `textarea` |
| VpcId | `vpcid` | `text` |

---
## Data Table - AWS Security Groups

 ![screenshot: dt-aws-security-groups](./screenshots/tableSecurityGroups.png)

#### API Name:
aws_security_groups

#### Columns:
| Column Name | API Access Name | Type |
| ----------- | --------------- | ---- |
| GroupName | `groupname` | `text` |
| Description | `sgdescription` | `text` |
| GroupId | `sggroupid` | `text` |
| OwnerID | `sgownerid` | `text` |
| VpcId | `vpcid` | `text` |

---


## Custom Artifact Types
| Display Name | API Access Name |
| ------------ | --------------- |
| AWS Instance ID | `aws_instance_id` |

---

## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example: AWS Tag instance | artifact | `example_aws_tag_instance_as_quarantined` |
| Example: AWS Describe Security Groups | artifact | `example_aws_describe_security_groups` |
| Example: AWS Change Security Groups | artifact | `example_aws_change_security_groups` |
| Example: AWS Take an AMI snapshot and Terminate | artifact | `example_aws_take_an_ami_snapshot_and_terminate` |
| Example: AWS Describe instance | artifact | `example_aws_describe_instance` |
| Example: AWS Invoke lambda function | incident | `example_aws_invoke_lamba_function` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->