<!--
  This User README.md is generated by running:
  "resilient-sdk docgen -p fn_aws --user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_aws_v1.0.0

## Table of Contents
- [Key Features](#key-features)
- [Function - AWS: create tags](#function---aws-create-tags)
- [Function - AWS: EC2 describe Instance](#function---aws-ec2-describe-instance)
- [Function - AWS: EC2 create snapshot](#function---aws-ec2-create-snapshot)
- [Function - AWS: delete key pair](#function---aws-delete-key-pair)
- [Function - AWS: EC2 describe Security Group](#function---aws-ec2-describe-security-group)
- [Function - AWS: Lambda invoke function](#function---aws-lambda-invoke-function)
- [Function - AWS: EC2 modify security groups](#function---aws-ec2-modify-security-groups)
- [Function - AWS: EC2 change instance status](#function---aws-ec2-change-instance-status)
- [Data Table - AWS Instances](#data-table---aws-instances)
- [Data Table - AWS Security Groups](#data-table---aws-security-groups)
- [Custom Artifact Types](#custom-artifact-types)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Key Feature 1
* Key Feature 2
* Key Feature 3

---

## Function - AWS: create tags
Assign Tags to resources. Multiple Tags and resources are allowed. 
Input multiple resources as: ami-xxx...xxx,i-xxx...xxx.
If a tag key already exists, the value is overwritten with the new value.

 ![screenshot: fn-aws-create-tags ](./screenshots/fn-aws-create-tags.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |
| `aws_tag_names` | `text` | Yes | `"[{'Key': 'First_Tag', 'Value': 'First Value'}, {'Key': 'Second_Tag', 'Value': 'Second Value'}]"` | - |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_region = 'sa-east-1'

inputs.aws_tag_names = "[{ 'Key': 'source', 'Value': 'Resilient' }, { 'Key': 'security_posture', 'Value': 'quarantine' }]"
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  incident.addNote('Tags created')
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 describe Instance
Gets the information of one o more Instance listed in aws_resource_id.
Searching by Instance Id is default. If 'image-id' is selected in aws_instances_filter_name, and one or more AMI id is entered, the output includes Instance information related to that AMI Id.

 ![screenshot: fn-aws-ec2-describe-instance ](./screenshots/fn-aws-ec2-describe-instance.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_instances_filter_name` | `select` | No | `-` | Criteria for searching instances |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_region = 'sa-east-1'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # Processing if the function is a success
if(results.success):
  reservations = results.reservations
  
  for rsv in reservations:
    instances = rsv['Instances']
  
    for inst in instances:
      # Add Row
      row = incident.addRow("aws_instances")
      row["instanceid"] = inst["InstanceId"]
      row["imageid"] = inst["ImageId"]
      row["instancetype"] = inst["InstanceType"]
      row["keyname"] = inst["KeyName"]
      row["launchtime"] = inst["LaunchTime"]
      row["availabilityzone"] = inst["Placement"]["AvailabilityZone"]
      row["privatednsname"] = inst["PrivateDnsName"]
      row["publicdnsname"] = inst["PublicDnsName"]
      row["instance_state"] = inst["State"]["Name"]
      row["vpcid"] = inst["VpcId"]
      row["securitygroups"] = ('\n'.join(list(map(lambda x : x['GroupName']+' ('+x['GroupId']+')', inst["SecurityGroups"]))) if "SecurityGroups" in inst.keys() else '')
      row["tags"] = ('\n'.join(list(map(lambda x : x['Key']+': '+x['Value'], inst["Tags"]))) if "Tags" in inst.keys() else '')
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 create snapshot
Creates a volume snapshot if aws_resource_id is a Volume (vol-xxx..xxx), or creates a complete image if it is an Instance Id (i-xxx...xxx)

 ![screenshot: fn-aws-ec2-create-snapshot ](./screenshots/fn-aws-ec2-create-snapshot.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('AMI from {} successfully created: {}'.format(artifact.value, results.snapshotId))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: delete key pair
Deletes the specified key pair, by removing the public key from Amazon EC2.
Use with extremely careful.

 ![screenshot: fn-aws-delete-key-pair ](./screenshots/fn-aws-delete-key-pair.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_key_name` | `text` | Yes | `-` | - |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  None
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  None
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 describe Security Group
Gets the information of one o more Security Group listed in aws_resource_id.
Searching by Security Group Id is default. Other options are available by changing aws_security_group_filter_name.

 ![screenshot: fn-aws-ec2-describe-security-group ](./screenshots/fn-aws-ec2-describe-security-group.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |
| `aws_security_group_filter_name` | `select` | No | `-` | Criteria for searching security groups |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  vpc = workflow.properties.instance_data.reservations[0]['Instances'][0]['VpcId']


inputs.aws_security_group_filter_name = 'vpc-id'
inputs.aws_resource_id = vpc



  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  #incident.addNote(str(results))

# Processing if the function is a success
if(results.success):
  sgs = results['securityGroups']
  
  for inst in sgs:
    # Add Row
    row = incident.addRow("aws_security_groups")
    
    row["groupname"] = inst["GroupName"]
    row["sgdescription"] = inst["Description"]
    row["sgownerid"] = inst["OwnerId"]
    row["sggroupid"] = inst["GroupId"]
    row["vpcid"] = inst["VpcId"]

  ```

  </p>
  </details>

</details>

---
## Function - AWS: Lambda invoke function
Invokes synchronously a Lambda function.

 ![screenshot: fn-aws-lambda-invoke-function ](./screenshots/fn-aws-lambda-invoke-function.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_lambda_function_name` | `text` | Yes | `-` | - |
| `aws_lambda_payload` | `text` | No | `-` | The JSON that you want to provide to your Lambda function as input |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_lambda_function_name = 'my-lambda-function'
inputs.aws_lambda_payload = '{"key1":"value1","key2":"value2"}'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  incident.addNote(str(results.lambdaResult))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 modify security groups
Replaces the Security Groups assigned to the Instance for those described in aws_security_groups (can be a list of security group Ids separated by comma)

 ![screenshot: fn-aws-ec2-modify-security-groups ](./screenshots/fn-aws-ec2-modify-security-groups.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |
| `aws_security_groups` | `text` | Yes | `-` | List of security groups Ids separated by comma to set in the Instance |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
inputs.aws_security_groups = 'sg-032bea0e7926abfbc,sg-01e6a74a8527336bb'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('Security Groups for Instance: {} were successfully changed.'.format(artifact.value))
  ```

  </p>
  </details>

</details>

---
## Function - AWS: EC2 change instance status
A function to change the state of one or more instances.
If hibernate is selected but the instances cannot hibernate successfully, a normal shutdown occurs.
Terminate instances is also allowed (use with extremely careful).

 ![screenshot: fn-aws-ec2-change-instance-status ](./screenshots/fn-aws-ec2-change-instance-status.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_access_key_name` | `text` | No | `-` | OPTIONAL to use different access key than default's. If not present, "aws_access_key_id" and "aws_secret_access_key" pair from app.config are used. |
| `aws_instance_status` | `select` | Yes | `-` | - |
| `aws_region` | `text` | No | `-` | If not present, "default_region" region from app.config is used |
| `aws_resource_id` | `text` | Yes | `-` | Where multiple values are allowed, enter them separated  by commas |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.aws_resource_id = artifact.value
#inputs.aws_instance_status = 'stop'
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  if results.success:
  incident.addNote('Status change results: {}'.format(str(results.statusInstances)))
  
  ```

  </p>
  </details>

</details>

---

## Data Table - AWS Instances

 ![screenshot: dt-aws-instances](./screenshots/dt-aws-instances.png)

#### API Name:
aws_instances

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| AvailabilityZone | `availabilityzone` | `text` | - |
| ImageId | `imageid` | `text` | - |
| State | `instance_state` | `text` | - |
| InstanceId | `instanceid` | `text` | - |
| InstanceType | `instancetype` | `text` | - |
| KeyName | `keyname` | `text` | - |
| LaunchTime | `launchtime` | `text` | - |
| PrivateDnsName | `privatednsname` | `text` | - |
| PublicDnsName | `publicdnsname` | `text` | - |
| SecurityGroups | `securitygroups` | `textarea` | - |
| Tags | `tags` | `textarea` | - |
| VpcId | `vpcid` | `text` | - |

---
## Data Table - AWS Security Groups

 ![screenshot: dt-aws-security-groups](./screenshots/dt-aws-security-groups.png)

#### API Name:
aws_security_groups

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| GroupName | `groupname` | `text` | - |
| Description | `sgdescription` | `text` | - |
| GroupId | `sggroupid` | `text` | - |
| OwnerID | `sgownerid` | `text` | - |
| VpcId | `vpcid` | `text` | - |

---


## Custom Artifact Types
| Display Name | API Access Name | Description |
| ------------ | --------------- | ----------- |
| AWS Instance ID | `aws_instance_id` |  |

---

## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example: AWS Tag instance | artifact | `example_aws_tag_instance_as_quarantined` |
| Example: AWS Describe Security Groups | artifact | `example_aws_describe_security_groups` |
| Example: AWS Change Security Groups | artifact | `example_aws_change_security_groups` |
| Example: AWS Take an AMI snapshot and Terminate | artifact | `example_aws_take_an_ami_snapshot_and_terminate` |
| Example: AWS Describe instance | artifact | `example_aws_describe_instance` |
| Example: AWS Invoke lambda function | incident | `example_aws_invoke_lamba_function` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->